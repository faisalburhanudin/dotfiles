#!/bin/bash

# Script to list Fly.io secrets and get their values from the running instance

# Check if app name is provided
if [ -z "$1" ]; then
    echo "Usage: $0 <app-name>"
    exit 1
fi

APP_NAME="$1"

echo "=== Fly.io Secrets ==="
echo "Listing secrets for app: $APP_NAME"

# Get secrets list and extract names
SECRETS_OUTPUT=$(fly secrets list -a "$APP_NAME")
echo "$SECRETS_OUTPUT"

# Extract secret names (skip header line)
SECRET_NAMES=$(echo "$SECRETS_OUTPUT" | tail -n +2 | awk '{print $1}' | grep -v '^$')

# Build grep pattern from secret names
if [ -z "$SECRET_NAMES" ]; then
    echo "No secrets found for app: $APP_NAME"
    exit 0
fi

# Join secret names with | for grep pattern
GREP_PATTERN=$(echo "$SECRET_NAMES" | paste -sd "|" -)

echo ""
echo "=== Secret Values from Running Instance ==="
echo "Connecting to instance to get environment variables..."

# Get environment variables matching the secret names
fly ssh console -a "$APP_NAME" --command "env" | grep -E "($GREP_PATTERN)" | sort

echo ""
echo "Done!"